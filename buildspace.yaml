version: 0.2
 
env:

  variables:

    ECR_REPO: "117431753750.dkr.ecr.us-east-1.amazonaws.com/docker/users"

    ECS_CLUSTER: "finalproject-cluster"

    ECS_SERVICE: "users-service"

  privileged: true
 
phases:

  pre_build:

    commands:

      - aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 977099001332.dkr.ecr.us-east-1.amazonaws.com

      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)

      - IMAGE_TAG=build-$COMMIT_HASH
 
  build:

    commands:

      - docker build -t $ECR_REPO:latest .

      - docker build -t $ECR_REPO:$IMAGE_TAG .
 
  post_build:

    commands:

      - docker push $ECR_REPO:latest

      - docker push $ECR_REPO:$IMAGE_TAG

      - printf '[{"name":"users","imageUri":"%s"}]' $ECR_REPO:$IMAGE_TAG > imagedefinitions.json
 
artifacts:

  files:

    - imagedefinitions.json

 
